generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

// No model for a user since auth is handled by Clerk
// Assume we get a unique userId for each user 
// TODO: for messenger we neeed a mapping from users to their PSID(page scoped ID)

model Preferences {
  id        String         @id @map("_id")
  resources UserResource[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Represents a URL resource that a user configured
// We may scrape these resources for content
type UserResource {
  url         String
  title       String
  description String
  active      Boolean @default(true)
}

// Represents a single audio recording
model AudioBlob {
  id            String  @id @map("_id")
  transcription String?
  owner         String // userId

  noteId String @unique
  note   Note   @relation(fields: [noteId], references: [id])

  title     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([owner])
}

// Represents a synthesized digest of audio recording(s)
// This can either be a single note or a digest over a collection of notes
model Note {
  id    String @id @map("_id")
  owner String //userId

  title      String
  content    String
  digestSpan NoteDigestSpan
  recording  AudioBlob?

  children NoteDigest[] @relation("childNote")
  parents  NoteDigest[] @relation("parentNote")

  active    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  conversation Conversation?
}

// Represents the span of a note digest
// e.g. if a note represents a digest over an entire day's notes
enum NoteDigestSpan {
  SINGLE
  DAILY
  WEEKLY
}

// Join collection for Note many-to-many self-relation
model NoteDigest {
  id String @id @map("_id")

  childId String
  child   Note   @relation("childNote", fields: [childId], references: [id])

  parentId String
  parent   Note   @relation("parentNote", fields: [parentId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([childId, parentId])
}

model Conversation {
  id    String @id @map("_id")
  owner String //userId, using fb PSID for now

  createdAt     DateTime @default(now())
  lastUpdatedAt DateTime @updatedAt
  isActive      Boolean  @default(true)

  userMessages   String[] //Messages sent from the user to brain2
  brain2Messages String[] //Messages sent from brain2 to the user

  noteId String? @unique
  note   Note?   @relation(fields: [noteId], references: [id])
}
